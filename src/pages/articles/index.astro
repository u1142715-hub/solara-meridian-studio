---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const base = (import.meta.env.BASE_URL || "/").replace(/\/$/, "");

const allArticles = await getCollection("articles");
const sorted = allArticles.sort((a, b) => b.data.publishedAt - a.data.publishedAt);
const hasArticles = sorted.length > 0;

// Featured selection: use frontmatter `featured: true` if present, otherwise latest.
const featured = sorted.find((a) => a.data?.featured === true) ?? sorted[0];

// Remaining articles (exclude featured if it exists)
const rest = featured ? sorted.filter((a) => a.id !== featured.id) : sorted;

// Group remaining into clusters of 3
const groups = [];
for (let i = 0; i < rest.length; i += 3) groups.push(rest.slice(i, i + 3));

const articleHref = (slug) => `${base}/articles/${slug}/`;
---

<BaseLayout title="Articles" description="Guides, insights, and resources.">
  <section class="articles-header">
    <h1>Articles</h1>
    <p>Guides, insights, and resources across Art.</p>
  </section>

  {hasArticles ? (
    <main class="articles">
      {/* Reading Hero (Featured) */}
      {featured ? (
        <section class="reading-hero" aria-label="Featured article">
          <div class="reading-hero__kicker">Featured reading</div>
          <h2 class="reading-hero__title">
            <a class="reading-hero__link" href={articleHref(featured.slug)}>
              {featured.data.title}
            </a>
          </h2>
          {featured.data.description ? (
            <p class="reading-hero__desc">{featured.data.description}</p>
          ) : null}
        </section>
      ) : null}

      {/* Clusters of 3 + accent breakers */}
      <section class="articles-list" aria-label="All articles">
        {groups.map((group, groupIndex) => {
          const articlesSeen = (groupIndex + 1) * 3; // counts in the grouped list
          const isChapterBreak = articlesSeen % 9 === 0; // every 3 groups of 3 (9)
          const isMinorBreak = !isChapterBreak; // after each 3 (including partial last group if present)

          return (
            <div class="articles-cluster">
              <div class="articles-cluster__grid">
                {group.map((a) => (
                  <article class="article-card">
                    <h3 class="article-card__title">
                      <a class="article-card__link" href={articleHref(a.slug)}>
                        {a.data.title}
                      </a>
                    </h3>
                    {a.data.description ? (
                      <p class="article-card__desc">{a.data.description}</p>
                    ) : null}
                  </article>
                ))}
              </div>

              {/* Breakers:
                  - thin accent line after every cluster of 3
                  - slightly thicker + more spacing every 9 (chapter) */}
              <div
                class:list={[
                  "articles-break",
                  isChapterBreak ? "articles-break--chapter" : "articles-break--minor",
                  // If this is the last cluster and it has fewer than 3, still show a minor break (ok).
                ]}
                aria-hidden="true"
              />
            </div>
          );
        })}
      </section>
    </main>
  ) : (
    <section class="articles-empty" aria-label="No articles yet">
      <p class="articles-empty__title">No articles published yet.</p>
      <p class="articles-empty__text">
        The first guide is being prepared. For now, you can explore the current body of work.
      </p>
      <p class="articles-empty__action">
        <a class="articles-empty__link" href={`${base}/art/`}>View the work</a>
      </p>
    </section>
  )}
</BaseLayout>

<style>
  .articles-header {
    padding: var(--space-4) 0;
    text-align: center;
  }
  .articles-header h1 {
    font-size: var(--font-size-3xl);
  }

  .articles {
    padding: var(--space-2) 0 var(--space-6);
  }

  /* Accent (uses site token if present; safe fallback keeps consistency) */
  :global(:root) {
    --sms-accent: var(--color-accent, var(--accent, rgba(214, 179, 106, 1)));
  }

  /* Reading Hero */
  .reading-hero {
    max-width: 72ch;
    margin: 0 auto var(--space-5);
    padding: var(--space-5);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.02);
  }
  .reading-hero__kicker {
    font-size: var(--font-size-sm);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.8;
    margin: 0 0 var(--space-2);
  }
  .reading-hero__title {
    margin: 0 0 var(--space-2);
    font-size: var(--font-size-2xl);
    line-height: 1.15;
  }
  .reading-hero__link {
    text-decoration: none;
  }
  .reading-hero__link:hover,
  .reading-hero__link:focus-visible {
    text-decoration: underline;
    text-decoration-color: var(--sms-accent);
    text-underline-offset: 0.18em;
  }
  .reading-hero__desc {
    margin: 0;
    opacity: 0.88;
    line-height: 1.7;
  }

  /* Article list (clusters of 3) */
  .articles-list {
    max-width: 72ch;
    margin: 0 auto;
  }

  .articles-cluster {
    margin: 0 0 var(--space-4);
  }

  .articles-cluster__grid {
    display: grid;
    gap: var(--space-3);
  }

  .article-card {
    padding: var(--space-4);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.02);
  }

  .article-card__title {
    margin: 0 0 var(--space-2);
    font-size: var(--font-size-lg);
    line-height: 1.25;
  }

  .article-card__link {
    text-decoration: none;
  }
  .article-card__link:hover,
  .article-card__link:focus-visible {
    text-decoration: underline;
    text-decoration-color: var(--sms-accent);
    text-underline-offset: 0.18em;
  }

  .article-card__desc {
    margin: 0;
    opacity: 0.85;
    line-height: 1.7;
  }

  /* Breakers */
  .articles-break {
    width: 100%;
    margin: var(--space-4) 0 0;
    border-radius: 999px;
    background: var(--sms-accent);
    opacity: 0.35;
  }
  .articles-break--minor {
    height: 1px;
  }
  .articles-break--chapter {
    height: 2px;
    margin-top: var(--space-5);
    opacity: 0.55;
  }

  /* Empty-state (only appears when no articles exist) */
  .articles-empty {
    max-width: 72ch;
    margin: var(--space-6) auto 0;
    padding: var(--space-5);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.02);
  }
  .articles-empty__title {
    margin: 0 0 var(--space-2);
    font-size: var(--font-size-lg);
  }
  .articles-empty__text {
    margin: 0 0 var(--space-3);
    opacity: 0.85;
    line-height: 1.7;
  }
  .articles-empty__link {
    text-decoration: none;
  }
  .articles-empty__link:hover,
  .articles-empty__link:focus-visible {
    text-decoration: underline;
    text-decoration-color: var(--sms-accent);
    text-underline-offset: 0.18em;
  }
</style>
