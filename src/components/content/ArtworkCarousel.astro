---
import "../../styles/components/artwork-carousel.css";

export interface ArtworkEntry {
  id: string;
  data: {
    title: string;
    slug: string;
    thumbnail: string;
    alt?: string;
  };
}

export interface ArtworkCarouselProps {
  artworks: ArtworkEntry[];
  label?: string;
}

const { artworks = [], label = "Featured artworks" } =
  Astro.props as ArtworkCarouselProps;
---

{artworks.length > 0 && (
  <section
    class="artwork-carousel"
    data-artwork-carousel
    aria-label={label}
  >
    <div
      class="artwork-carousel__viewport"
      data-carousel-viewport
      tabindex="0"
    >
      <ul class="artwork-carousel__track">
        {artworks.map((artwork, index) => (
         <li
  class="artwork-carousel__slide"
  data-carousel-slide
  id={`artwork-carousel-slide-${index}`}
>
  <a
    class="artwork-carousel__card"
    href={artwork.data.saatchiUrl}
    target="_blank"
    rel="noopener noreferrer"
    aria-label={`${artwork.data.title} – view on Saatchi Art`}
  >
    <figure class="artwork-carousel__figure">
      <img
        src={artwork.data.thumbnail}
        alt={artwork.data.alt ?? artwork.data.title}
        loading={index === 0 ? "eager" : "lazy"}
        class="artwork-carousel__image"
      />
      <figcaption class="artwork-carousel__caption">
        {artwork.data.title}
      </figcaption>
    </figure>
  </a>
</li>

        ))}
      </ul>
    </div>

    {artworks.length > 1 && (
      <div class="artwork-carousel__controls">
        <button
          type="button"
          class="artwork-carousel__nav-button"
          data-carousel-prev
          aria-label="Previous artwork"
        >
          ‹
        </button>

        <div
          class="artwork-carousel__dots"
          role="tablist"
          aria-label="Select artwork"
        >
          {artworks.map((artwork, index) => (
            <button
              type="button"
              class="artwork-carousel__dot"
              data-carousel-dot
              aria-label={`Show ${artwork.data.title}`}
              aria-controls={`artwork-carousel-slide-${index}`}
            />
          ))}
        </div>

        <button
          type="button"
          class="artwork-carousel__nav-button"
          data-carousel-next
          aria-label="Next artwork"
        >
          ›
        </button>
      </div>
    )}
  </section>
)}

<script is:inline>
  (() => {
    if (typeof window === "undefined") return;

    const carousels = document.querySelectorAll("[data-artwork-carousel]");

    carousels.forEach((carousel) => {
      const viewport = carousel.querySelector(
        "[data-carousel-viewport]"
      );
      const slides = Array.from(
        carousel.querySelectorAll("[data-carousel-slide]")
      );
      const dots = Array.from(
        carousel.querySelectorAll("[data-carousel-dot]")
      );
      const prev = carousel.querySelector("[data-carousel-prev]");
      const next = carousel.querySelector("[data-carousel-next]");

      if (!viewport || slides.length === 0) return;

      let currentIndex = 0;

      const getSlideWidth = () => {
        const first = slides[0];
        if (!first) return viewport.clientWidth;
        const rect = first.getBoundingClientRect();
        return rect.width || viewport.clientWidth;
      };

      const clampIndex = (index) =>
        Math.max(0, Math.min(index, slides.length - 1));

      const updateDots = () => {
        if (!dots.length) return;
        dots.forEach((dot, index) => {
          const isActive = index === currentIndex;
          dot.classList.toggle("is-active", isActive);
          dot.setAttribute("aria-selected", isActive ? "true" : "false");
          dot.setAttribute("tabindex", isActive ? "0" : "-1");
        });
      };

      const goTo = (index, { smooth = true } = {}) => {
        currentIndex = clampIndex(index);
        const offset = getSlideWidth() * currentIndex;
        viewport.scrollTo({
          left: offset,
          behavior: smooth ? "smooth" : "auto",
        });
        updateDots();
      };

      prev?.addEventListener("click", () => {
        goTo(currentIndex - 1);
      });

      next?.addEventListener("click", () => {
        goTo(currentIndex + 1);
      });

      dots.forEach((dot, index) => {
        dot.addEventListener("click", () => {
          goTo(index);
        });
      });

      carousel.addEventListener("keydown", (event) => {
        if (event.key === "ArrowRight") {
          event.preventDefault();
          goTo(currentIndex + 1);
        } else if (event.key === "ArrowLeft") {
          event.preventDefault();
          goTo(currentIndex - 1);
        }
      });

      window.addEventListener("resize", () => {
        goTo(currentIndex, { smooth: false });
      });

      goTo(0, { smooth: false });
    });
  })();
</script>
